- key: system-packages
  run: |
    # running from a base with `config: none`; need openssl and jq too
    if ! command -v openssl >/dev/null 2>&1 || ! command -v jq >/dev/null 2>&1; then
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache openssl jq
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get -y update
        apt-get -y install openssl jq
        apt-get clean
      else
        echo "Unsupported package manager; need openssl and jq installed" >&2
        exit 1
      fi
    fi

- key: pagerduty-verify-signature--test-valid-signature
  use: system-packages
  call: $LEAF_DIGEST
  with:
    body: '{"event":"incident.triggered","id":"test-123"}'
    headers: '{"x-pagerduty-signature":"v1=628a47742d0e028f883a3a20f2777a49c9730395f9c7780984f1d3cb0de2046a"}'
    shared-secret: test-secret-key

- key: pagerduty-verify-signature--test-multiple-signatures-one-valid
  use: system-packages
  call: $LEAF_DIGEST
  with:
    body: '{"event":"incident.resolved","id":"test-456"}'
    headers: '{"x-pagerduty-signature":"v1=invalid_sig1,v1=889dbec24e1dd126e2523ef80fa56afe1fe468f485367e6e62add02c10a87faf,v1=another_invalid"}'
    shared-secret: another-test-secret
