name: github/open-pull-request
version: 1.0.0
description: Opens a pull request
source_code_url: https://github.com/rwx-cloud/packages/tree/main/github/open-pull-request
issue_tracker_url: https://github.com/rwx-cloud/packages/issues

parameters:
  github-token:
    description: "The GitHub token to a private app"
    required: true
  branch-prefix:
    description: "Branch prefix for opened pull requests"
    required: true
  commit-message:
    description: "The message to use for the commit"
    required: true
  pull-request-title:
    description: "The title to use for the pull request"
    required: true

outputs:
  values-from: [open-or-update-pull-request]

tasks:
  - key: gh-cli
    call: github/install-cli 1.0.6

  - key: open-or-update-pull-request
    use: [gh-cli]
    cache: false
    run: |
      if [ -n "$(git status --porcelain)" ]; then
        git add --all
        git commit -m "$COMMIT_MESSAGE"
      else
        echo "No changes to commit"
        exit 0
      fi

      pr_list=$(gh pr list --author @me --json number,headRefName)
      echo "$pr_list"

      latest_pr=$(echo "$pr_list" |  jq "[.[] | select(.headRefName | startswith(\"${BRANCH_PREFIX}-\"))] | max_by(.number)")
      echo "$latest_pr"

      if [ "$latest_pr" != "null" ] && [ -n "$latest_pr" ]; then
        branch=$(echo "$latest_pr" | jq -r ".headRefName")
        need_to_open_pr=false
      else
        branch="${BRANCH_PREFIX}-${RWX_RUN_ID}"
        need_to_open_pr=true
      fi
      echo "$branch" | tee $RWX_VALUES/branch

      git checkout -b "$branch"
      git push -f origin "$branch"

      if [ "$need_to_open_pr" = "true" ]; then
        gh pr create --title "$PULL_REQUEST_TITLE" --body "$COMMIT_MESSAGE"
      else
        gh pr edit --title "$PULL_REQUEST_TITLE" --body "$COMMIT_MESSAGE"
      fi
      gh pr view "$branch" --json number | jq -r '.number' | tee $RWX_VALUES/pull-request-number
    env:
      BRANCH_PREFIX: ${{ params.branch-prefix }}
      COMMIT_MESSAGE: ${{ params.commit-message }}
      GITHUB_TOKEN: ${{ params.github-token }}
      PULL_REQUEST_TITLE: ${{ params.pull-request-title }}
