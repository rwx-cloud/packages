name: git/clone
version: 1.9.0
description: Clone git repositories over ssh or http, with support for Git Large File Storage (LFS)
source_code_url: https://github.com/rwx-cloud/packages/tree/main/git/clone
issue_tracker_url: https://github.com/rwx-cloud/packages/issues

parameters:
  github-access-token:
    description: "Token to clone from GitHub over HTTPS"
    required: false
  lfs:
    description: Whether to download Git-LFS files
    default: false
  path:
    description: "The relative path within the workspace into which the repository will be cloned"
    default: "./"
  preserve-git-dir:
    description: "Whether or not to preserve the .git directory. Set to true if you want to perform git operations like committing after cloning. Preserving the .git directory will decreaes the likelihood of cache hits when a file filter is not specified."
    default: false
  ref:
    description: "The ref to check out of the git repository"
    required: true
  meta-ref:
    description: "The unresolved name of the ref being checked out (used to set RWX_GIT_REF_NAME). e.g. refs/heads/main or refs/tags/v1.0.0"
    required: false
  repository:
    description: "The url of a git repository."
    required: true
  ssh-key:
    description: "The ssh key to use if cloning over ssh"
    required: false
  fetch-full-depth:
    description: "Whether to use a shallow fetch or a full-depth fetch when the repository is cloned and when not preserving the git directory (when `preserve-git-dir` is true, this parameter has no effect). Typically, setting this to `false` (the default) will result in better cloning performance within RWX. However, for certain large repositories, a full depth fetch may be faster."
    default: false
  submodules:
    description: Whether to clone submodules
    default: true

tasks:
  - key: setup
    run: |
      . "$RWX_PACKAGE_PATH/rwx-utils.sh"
      if ! rwx_os_package_manager_in apt apk; then
        echo "Unsupported operating system or package manager \`$(rwx_os_package_manager)\`" > "$(mktemp "$RWX_ERRORS/error-XXXXXX")"
        exit 1
      fi

      needed=""

      if ! command -v jq >/dev/null 2>&1; then
        needed="$needed jq"
      fi

      if ! command -v curl >/dev/null 2>&1; then
        needed="$needed curl"
      fi

      if [ -n "$needed" ]; then
        cat << EOF > ${RWX_ERRORS}/missing-packages
      The \`git/clone\` package requires system packages that were missing:$needed

      Define a task which installs those packages, and specify it as a \`use\` dependency of the \`git/clone\` task
      EOF
        exit 1
      fi

      packages_to_install=""

      if ! command -v git >/dev/null 2>&1; then
        packages_to_install="$packages_to_install git"
      fi

      if ! command -v ssh >/dev/null 2>&1; then
        packages_to_install="$packages_to_install openssh-client"
      fi

      if [ -n "$packages_to_install" ]; then
        package_manager="$(rwx_os_package_manager)"
        case "$package_manager" in
          apt)
            rwx_maybe_sudo apt-get -y update
            rwx_maybe_sudo apt-get -y install $packages_to_install
            rwx_maybe_sudo apt-get -y clean
            ;;
          apk)
            apk_packages=$(echo "$packages_to_install" | sed 's/openssh-client/openssh/g')
            rwx_maybe_sudo apk add --no-cache $apk_packages
            ;;
        esac
      fi

      rwx_maybe_sudo install $RWX_PACKAGE_PATH/bin/git-ssh-command /usr/local/bin
      echo "git-ssh-command" >> $RWX_ENV/GIT_SSH_COMMAND
      if [ -n "$GIT_SSH_KEY" ]; then
        case "$CHECKOUT_REPOSITORY" in
          http://*|https://*)
            errorMessage=$(mktemp "$RWX_ERRORS/error-XXXXXX")
            cat << EOF > "$errorMessage"
      Invalid parameters: \`repository\` points to an HTTP URL, but \`ssh-key\` was set.

      The current value is \`$CHECKOUT_REPOSITORY\`.
      EOF
            github_path="${CHECKOUT_REPOSITORY#https://github.com/}"
            if [ "$github_path" = "$CHECKOUT_REPOSITORY" ]; then
              github_path="${CHECKOUT_REPOSITORY#http://github.com/}"
            fi
            if [ "$github_path" != "$CHECKOUT_REPOSITORY" ]; then
              case "$github_path" in
                */*)
                  org="${github_path%%/*}"
                  repo_part="${github_path#*/}"
                  repo="${repo_part%.git}"

                  truncate -s-1 "$errorMessage"
                  echo " Perhaps you meant \`git@github.com:$org/$repo.git\`?" >> "$errorMessage"
                  ;;
              esac
            fi
            exit 2
            ;;
        esac

        : > "$RWX_VALUES/credential-helper"
      else
        case "$CHECKOUT_REPOSITORY" in
          http://*|https://*)
            ;;
          *)
            errorMessage=$(mktemp "$RWX_ERRORS/error-XXXXXX")
            cat << EOF > "$errorMessage"
      Invalid parameters: \`repository\` must point to an HTTP URL if \`ssh-key\` is not set.

      The current value is \`$CHECKOUT_REPOSITORY\`.
      EOF
            ssh_path="${CHECKOUT_REPOSITORY#git@github.com:}"
            if [ "$ssh_path" != "$CHECKOUT_REPOSITORY" ]; then
              case "$ssh_path" in
                */*)
                  org="${ssh_path%%/*}"
                  repo_part="${ssh_path#*/}"
                  repo="${repo_part%.git}"

                  truncate -s-1 "$errorMessage"
                  echo " Perhaps you meant \`https://github.com/$org/$repo.git\`?" >> "$errorMessage"
                  ;;
              esac
            fi
            exit 2
            ;;
        esac

        echo "Setting credential.helper to clone using github-access-token"
        printf '%s' '!sh -c "echo username=x-access-token && echo password=${GITHUB_TOKEN}"' > "$RWX_VALUES/credential-helper"
      fi
    env:
      GIT_SSH_KEY: ${{ params.ssh-key }}
      CHECKOUT_REPOSITORY: ${{ params.repository }}

  - key: get-latest-sha-for-ref
    use: setup
    run: $RWX_PACKAGE_PATH/bin/get-latest-sha-for-ref
    env:
      GIT_SSH_KEY:
        value: ${{ params.ssh-key }}
        cache-key: excluded
      GITHUB_TOKEN:
        value: ${{ params.github-access-token }}
        cache-key: excluded
      CHECKOUT_REF: ${{ params.ref }}
      CHECKOUT_REPOSITORY: ${{ params.repository }}
      CREDENTIAL_HELPER: ${{ tasks.setup.values.credential-helper }}
      PATCHES_DIR: ${{ run.dir }}/.patches
    filter:
      ${{ run.dir }}: [.patches]
    cache: ${{ params.ref =~ '^[0-9a-f]{40}$' }}

  - key: install-lfs
    run: |
      if [ "${LFS}" != "true" ]; then
        echo "params.lfs is false; skipping lfs install"
        exit 0
      fi

      . "$RWX_PACKAGE_PATH/rwx-utils.sh"

      package_manager="$(rwx_os_package_manager)"
      case "$package_manager" in
        apt)
          rwx_maybe_sudo apt-get -y update
          rwx_maybe_sudo apt-get -y install git-lfs
          rwx_maybe_sudo apt-get -y clean
          ;;
        apk)
          rwx_maybe_sudo apk add --no-cache git-lfs
          ;;
        *)
          echo "Unsupported operating system or package manager \`$package_manager\` for installing git-lfs" > "$(mktemp "$RWX_ERRORS/error-XXXXXX")"
          exit 1
          ;;
      esac
    env:
      LFS: ${{ params.lfs }}

  - key: git-clone
    use: [setup, install-lfs]
    run: $RWX_PACKAGE_PATH/bin/git-clone
    env:
      GIT_LFS_SKIP_SMUDGE: 1
      GIT_SSH_KEY:
        value: ${{ params.ssh-key }}
        cache-key: excluded
      GITHUB_TOKEN:
        value: ${{ params.github-access-token }}
        cache-key: excluded
      CHECKOUT_PATH: ${{ params.path }}
      CHECKOUT_REF: ${{ params.ref }}
      RESOLVED_SHA: ${{ tasks.get-latest-sha-for-ref.values.sha }}
      CHECKOUT_REPOSITORY: ${{ params.repository }}
      META_REF: ${{ params.meta-ref }}
      LFS: ${{ params.lfs }}
      PRESERVE_GIT_DIR: ${{ params.preserve-git-dir }}
      CREDENTIAL_HELPER: ${{ tasks.setup.values.credential-helper }}
      FETCH_FULL_DEPTH: ${{ params.fetch-full-depth }}
      SUBMODULES: ${{ params.submodules }}

  - key: configure-git
    use: [git-clone]
    run: |
      if [ "${PRESERVE_GIT_DIR}" = "false" ]; then
        exit 0
      fi
      if [ -z "$GITHUB_TOKEN" ]; then
        exit 0
      fi
      cd "${CHECKOUT_PATH}"

      git config credential.helper '!sh -c "echo username=x-access-token && echo password=${GITHUB_TOKEN}"'

      QUERY="query { viewer { databaseId login } }"

      ACCESS_TOKEN_DATA=$(curl \
        -fsSL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer ${GITHUB_TOKEN}" \
        -X POST \
        -d "{ \"query\": \"${QUERY}\"}" \
        https://api.github.com/graphql \
      )

      GIT_USERNAME=$(echo $ACCESS_TOKEN_DATA | jq -r '.data.viewer.login')
      ACCESS_TOKEN_ID=$(echo $ACCESS_TOKEN_DATA | jq -r '.data.viewer.databaseId')
      GIT_EMAIL="${ACCESS_TOKEN_ID}+${GIT_USERNAME}@users.noreply.github.com"

      git config user.email $GIT_EMAIL
      git config user.name $GIT_USERNAME
    env:
      CHECKOUT_PATH: ${{ params.path }}
      GITHUB_TOKEN:
        value: ${{ params.github-access-token }}
        cache-key: excluded
      PRESERVE_GIT_DIR: ${{ params.preserve-git-dir }}
    filter:
      - ${{ tasks.git-clone.values.git-dir-path }}
